
window.addEventListener("load", setup, false);



var largeurFenetre = window.innerWidth;
var width = largeurFenetre;
var height = window.innerHeight;



var canvas;
var dessin;
var projection = d3.geo
	//.azimuthalEqualArea();
	//.conicEquidistant();
	//.orthographic();
	.mercator();
projection.scale(80);
var path = d3.geo.path().projection(projection);
	
var imageTexture;
var centroid;
var centroid2d;







function lireCsv(url, callback) {
	d3.csv(url, function(d){ callback(null, d); });
}
function lireJson(url, callback) {
	d3.json(url, function(d){ callback(null, d); });
}


function setup()
{	
	queue()
		.defer(lireJson, "world-countries-clean.json")
		.defer(lireCsv, "index2013.csv")
		.awaitAll(ready);
	
}


function ready(error, results) 
{
	queue()
		.defer(init, results)
		.awaitAll(ready2);
}




function init(results, callback)
{

	centroid = [];
	centroid2d = [];

	var HG = projection([-180,	84]);
	var HD = projection([180,	84]);
	var BD = projection([180,	-84]);
	var BG = projection([-180,	-84]);
	var MG = projection([-180,	0]);
	var MD = projection([180,	0]);

	centroid.push( [ HG[0] , HG[1] , 0 ]);
	centroid.push( [ HD[0] , HD[1] , 0 ]);
	centroid.push( [ MG[0] , MG[1] , 0 ]);
	centroid.push( [ MD[0] , MD[1] , 0 ]);
	centroid.push( [ BG[0] , BG[1] , 0 ]);
	centroid.push( [ BD[0] , BD[1] , 0 ]);

	centroid2d.push({ x: HG[0], y: HG[1], z:0 });
	centroid2d.push({ x: HD[0], y: HD[1], z:0 });
	centroid2d.push({ x: MG[0], y: MG[1], z:0 });
	centroid2d.push({ x: MD[0], y: MD[1], z:0 });
	centroid2d.push({ x: BG[0], y: BG[1], z:0 });
	centroid2d.push({ x: BD[0], y: BD[1], z:0 });


	var nbPointsParCote = 20;
	for(var i = 1; i < nbPointsParCote-1; i++)
	{
		var pointLigneHaut = projection([map(i, 0, nbPointsParCote, -180, 180),	84]);
		var pointLigneBas = projection([map(i, 0, nbPointsParCote, -180, 180),	-84]);
		var pointLigneGauche = projection([ -180, map(i, 0, nbPointsParCote, -84, 84)]);
		var pointLigneDroite = projection([ 180, map(i, 0, nbPointsParCote, -84, 84)]);

		centroid.push( [ pointLigneHaut[0] , pointLigneHaut[1] , 0 ]);
		centroid.push( [ pointLigneBas[0] , pointLigneBas[1] , 0 ]);
		centroid.push( [ pointLigneGauche[0] , pointLigneGauche[1] , 0 ]);
		centroid.push( [ pointLigneDroite[0] , pointLigneDroite[1] , 0 ]);


		centroid2d.push({ x: pointLigneHaut[0] , 	y:pointLigneHaut[1], z:0 });
		centroid2d.push({ x: pointLigneBas[0] , 	y:pointLigneBas[1], z:0 });
		centroid2d.push({ x: pointLigneGauche[0] , y:pointLigneGauche[1], z:0 });
		centroid2d.push({ x: pointLigneDroite[0] , y:pointLigneDroite[1], z:0 });
	}




	// Ajout de points
	var amerique = [[-164.564,-51.229],[-168.643,-49.898],[-166.691,-48.5],[-164.994,-48.162],[-163.619,-48.294],[
-162.641,-47.962],[-162.199,-48.348],[-161.721,-48.469],[-162.033,-48.27],[-161.285,-47.98],[-161.158,-47.61],[-161.631,-47.385],[
-162.402,-47.491],[-163.172,-46.956],[-163.699,-47.098],[-164.84,-46.979],[-166.523,-44.924],[-165.709,-44.434],[-165.703,-43.867],[
-166.488,-43.962],[-168.145,-43.659],[-166.201,-42.896],[-165.191,-43.162],[-165.309,-43.654],[-163.934,-42.941],[-162.633,-43.141],[
-162.268,-42.932],[-162.301,-41.817],[-161.232,-41.816],[-160.514,-42.105],[-159.98,-41.389],[-159.627,-41.864],[-159.078,-41.438],[
-158.486,-41.836],[-158.268,-41.719],[-157.781,-41.848],[-158.062,-41.008],[-165.404,-38.162],[-164.963,-37.737],[-160.234,-38.891],[
-159.529,-38.817],[-152.846,-42.205],[-153.539,-42.675],[-152.006,-43.604],[-152.014,-42.235],[-147.615,-43.197],[-147.826,-43.954],[
-147.166,-44.089],[-134.352,-41.288],[-130.521,-38.018],[-130.514,-37.854],[-129.305,-37.21],[-129.131,-36.509],[-127.85,-36.143],[
-127.436,-34.883],[-123.277,-33.524],[-122.893,-32.798],[-123.756,-32.958],[-123.51,-33.011],[-125.756,-34.442],[-128.357,-34.833],[
-128.443,-34.643],[-128.059,-34.198],[-124.818,-33.077],[-120.51,-22.969],[-119.596,-22.907],[-119.234,-22.735],[-118.789,-22.71],[
-118.695,-22.553],[-117.615,-22.174],[-117.395,-21.752],[-116.994,-21.77],[-114.162,-19.544],[-114.199,-19.276],[-114.57,-19.057],[
-114.982,-19.089],[-115.055,-19.045],[-113.598,-18.408],[-113.465,-18.484],[-112.301,-18.043],[-112.182,-17.308],[-110.031,-16.214],[
-109.854,-16.211],[-109.434,-16.42],[-109.408,-16.521],[-110.174,-17.036],[-110.654,-17.055],[-112.961,-19.46],[-113.139,-19.451],[
-114.936,-21.248],[-114.775,-21.497],[-114.205,-21.328],[-113.871,-21.354],[-111.178,-19.174],[-110.641,-19.125],[-109.801,-18.43],[
-109.291,-18.294],[-109.443,-17.936],[-105.266,-15.425],[-105.271,-15.23],[-105.5,-15.085],[-105.396,-14.927],[-105.73,-14.872],[
-96.557,-12.247],[-93.875,-12.401],[-87.904,-10.896],[-87.795,-11.021],[-87.49,-10.977],[-87.316,-10.81],[-87.393,-10.771],[-87.557,-10.852],[
-87.67,-10.769],[-85.713,-9.797],[-85.941,-9.694],[-85.658,-9.619],[-85.797,-9.29],[-85.66,-9.183],[-85.34,-9.131],[-85.111,-8.983],[
-84.91,-9.11],[-84.977,-9.265],[-84.713,-9.17],[-84.646,-9.015],[-83.633,-8.717],[-83.596,-8.6],[-83.711,-8.508],[-82.85,-8.2],[-82.818,-8.315],[
-81.721,-8.22],[-81.52,-8.007],[-81.189,-7.976],[-81.059,-8.065],[-80.887,-7.751],[-80.004,-7.923],[-80.48,-8.209],[-80.383,-8.318],[
-79.76,-8.47],[-79.557,-8.654],[-79.119,-8.688],[-78.621,-8.54],[-78.436,-8.366],[-78.182,-8.329],[-78.428,-8.188],[-77.318,-7.028],[
-77.531,-6.891],[-77.307,-6.411],[-77.496,-6.107],[-77.129,-5.983],[-77.932,-5.379],[-78.428,-5.344],[-78.662,-5.154],[-78.617,-4.893],[
-78.99,-4.854],[-78.855,-4.691],[-80.09,-4.372],[-80.02,-4.159],[-80.582,-3.498],[-80.934,-3.418],[-80.766,-2.945],[-80.967,-2.797],[
-80.369,-2.568],[-79.986,-2.811],[-79.77,-2.583],[-81.41,-1.496],[-80.926,-0.995],[-81.25,-0.761],[-76.26,3.162],[-76.424,3.316],[
-71.461,5.234],[-71.375,5.46],[-70.371,5.776],[-73.166,16.929],[-73.588,16.951],[-74.33,21.102],[-73.701,21.203],[-73.389,20.315],[
-72.717,20.504],[-73.24,21.992],[-74.352,21.735],[-75.645,23.627],[-74.127,23.85],[-75.607,25.197],[-74.945,28.143],[-71.43,29.528],[
-71.008,29.508],[-70.844,28.69],[-69.461,28.169],[-68.15,28.219],[-69.139,26.859],[-65.641,24.077],[-66.596,23.922],[-67.58,23.365],[
-67.293,22.802],[-66.51,22.422],[-65.564,22.419],[-65.182,21.296],[-63.459,20.63],[-63.756,20.264],[-64.303,20.486],[-64.979,20.273],[
-65.117,19.58],[-64.732,19.399],[-63.77,19.651],[-62.146,19.312],[-62.336,18.057],[-57.75,17.627],[-56.736,16.464],[-57.361,16.183],[
-57.225,15.74],[-58.494,15.195],[-58.428,14.866],[-57.818,15.215],[-57.139,15.194],[-56.215,15.467],[-55.674,15.399],[-54.936,15.526],[
-48.889,11.665],[-48.496,10.021],[-41.988,8.355],[-41.754,8.017],[-40.945,7.771],[-38.674,2.906],[-38.424,2.895],[-35.129,0.745],[
-35.236,-1.113],[-43.42,-2.727],[-44.58,-2.564],[-44.418,-2.854],[-44.906,-3.16],[-47.824,-3.667],[-48.584,-3.324],[-48.621,-3.848],[
-50.389,-3.93],[-50.699,-4.088],[-49.947,-4.518],[-49.973,-4.877],[-50.508,-4.963],[-51.316,-6.168],[-51.656,-6.144],[-55.842,-7.085],[
-55.949,-6.99],[-57.146,-7.095],[-58.078,-7.534],[-58.455,-7.547],[-58.482,-7.818],[-60.15,-8.479],[-60.672,-8.468],[-60.83,-8.892],[
-62.389,-9.191],[-62.729,-9.442],[-61.881,-9.599],[-64.318,-9.559],[-64.328,-9.425],[-64.891,-9.26],[-68.195,-9.513],[-68.232,-9.688],[
-68.883,-9.985],[-69.584,-9.994],[-69.943,-10.369],[-70.295,-10.2],[-70.156,-9.949],[-71.4,-9.733],[-71.35,-9.331],[-71.039,-9.145],[
-71.266,-8.762],[-71.695,-8.729],[-72.074,-9.146],[-71.633,-9.456],[-71.619,-9.733],[-71.945,-9.975],[-71.359,-10.036],[-71.137,-10.343],[
-71.4,-10.483],[-71.756,-10.517],[-73.414,-9.87],[-74.197,-9.915],[-74.275,-9.804],[-74.906,-9.794],[-75.48,-9.547],[-75.674,-8.923],[
-76.836,-8.498],[-79.059,-8.93],[-79.021,-8.981],[-79.572,-9.013],[-81.439,-8.576],[-81.715,-8.706],[-81.809,-8.663],[-82.207,-8.688],[
-82.188,-8.8],[-83.809,-9.805],[-83.855,-9.948],[-83.65,-10.085],[-83.627,-10.454],[-83.473,-10.507],[-83.412,-11.338],[-83.182,-11.521],[
-83.232,-11.839],[-83.146,-11.892],[-87.523,-12.325],[-87.615,-12.369],[-87.9,-12.361],[-88.121,-12.266],[-88.518,-12.356],[-88.604,-12.275],[
-88.93,-12.374],[-88.732,-12.562],[-88.551,-12.579],[-88.24,-12.999],[-88.303,-13.052],[-88.197,-13.247],[-88.285,-13.331],[-88.105,-13.718],[
-88.297,-13.721],[-88.301,-13.802],[-88.09,-13.811],[-87.838,-13.669],[-87.436,-14.338],[-87.621,-14.435],[-86.811,-15.374],[-87.053,-15.492],[
-90.279,-15.188],[-90.771,-14.233],[-94.426,-13.606],[-94.84,-13.836],[-95.9,-13.981],[-97.703,-17.04],[-97.289,-17.767],[-96.584,-17.799],[
-96.842,-18.999],[-93.801,-20.045],[-91.727,-20.01],[-91.016,-19.707],[-90.066,-19.684],[-89.76,-19.775],[-89.357,-19.681],[-88.691,-19.956],[
-89.066,-20.166],[-89.053,-20.387],[-89.078,-20.41],[-86.453,-20.451],[-85.076,-19.98],[-84.09,-20.248],[-83.029,-19.52],[-83.229,-19.135],[
-81.453,-17.42],[-80.646,-17.306],[-80.096,-17.439],[-80.996,-21.205],[-75.355,-23.801],[-75.648,-24.82],[-73.615,-27.035],[-71.201,-27.344],[
-71.641,-27.539],[-69.656,-27.775],[-69.641,-27.814],[-69.629,-27.814],[-69.494,-28.182],[-70.459,-28.685],[-70.459,-28.738],[
-69.879,-29.222],[-66.527,-30.118],[-66.775,-30.466],[-64.426,-30.551],[-66.16,-29.942],[-66.123,-29.327],[-65.363,-29.274],[-59.803,-31.021],[
-60.447,-31.292],[-60.518,-31.845],[-61.52,-30.993],[-63.174,-30.884],[-64.471,-31.259],[-65.115,-32.666],[-64.17,-33.194],[-65.057,-33.585],[
-69.24,-32.472],[-69.268,-32.488],[-70.256,-31.827],[-71.104,-31.702],[-66.398,-34.39],[-60.031,-34.4],[-55.684,-35.986],[-55.756,-36.954],[
-56.158,-37.285],[-56.936,-37.402],[-57.334,-38.157],[-61.799,-39.737],[-61.396,-40.334],[-64.584,-43.717],[-67.648,-41.545],[
-68.375,-42.135],[-69.287,-42.293],[-69.59,-44.49],[-71.373,-44.572],[-73.84,-46.016],[-74.668,-45.721],[-77.41,-46.137],[-78.107,-45.875],[
-77.338,-43.21],[-78.516,-42.139],[-76.621,-40.559],[-77.096,-39.267],[-79.828,-38.195],[-78.602,-36.341],[-79.143,-35.468],[-79.912,-35.196],[
-82.125,-36.96],[-82.271,-38.632],[-90.896,-40.639],[-92.297,-40.448],[-93.217,-42.115],[-94.684,-42.283],[-91.932,-46.46],[-90.77,-46.604],[
-90.703,-47.358],[-89.914,-47.857],[-88.482,-47.938],[-85.768,-51.017],[-84.734,-50.623],[-81.387,-51.749],[-81.26,-52.409],[-81.965,-53.15],[
-81.279,-54.626],[-82.621,-55.364],[-85.521,-55.702],[-87.35,-51.868],[-88.318,-52.789],[-88.02,-53.834],[-89.215,-54.77],[-90.551,-53.634],[
-90.547,-55.123],[-92.406,-55.427],[-91.52,-56.175],[-93.891,-58.688],[-95.209,-58.956],[-96.471,-56.018],[-94.232,-54.49],[-94.686,-53.054],[
-95.488,-53.093],[-96.127,-51.995],[-96.119,-53.301],[-97.67,-53.782],[-98.559,-53.534],[-98.443,-52.663],[-101.453,-52.479],[
-103.221,-53.104],[-104.338,-52.991],[-106.148,-54.101],[-108.168,-53.89],[-108.812,-53.403],[-107.793,-52.809],[-108.881,-52.115],[
-109.945,-52.938],[-115.305,-52.83],[-113.898,-53.526],[-122.684,-55.661],[-123.061,-55.222],[-124.289,-54.979],[-124.424,-56.124],[
-125.758,-55.099],[-127.447,-56.462],[-128.137,-56.628],[-128.359,-55.9],[-129.107,-55.546],[-129.795,-56.179],[-132.928,-55.135],[
-134.414,-55.317],[-136.504,-54.241],[-140.627,-55.375],[-140.627,-55.573],[-143.553,-56.319],[-144.896,-56.068],[-149.695,-56.899],[
-150.732,-56.74],[-151.889,-56.94],[-151.822,-57.34],[-154.062,-57.467],[-154.287,-57.31],[-154.809,-57.828],[-156.67,-58.248],[
-158.24,-57.37],[-159.115,-57.473],[-164.588,-54.45],[-166.453,-54.401],[-167.205,-53.393],[-162.256,-50.613],[-163.387,-50.587],[
-163.254,-51.229]];




	for(var i = 0; i < amerique.length; i++)
	{
		var projectPoints = projection([ amerique[i][0], amerique[i][1] ], 0);
		//centroid.push( [ projectPoints[0], projectPoints[1], 0 ] );
		centroid2d.push({ x: projectPoints[0] , y: projectPoints[1], z: 0 });
	}



	var newForme2 = [[175.725,-55.694],[-5.271,-0.334],[-0.445,0.673],[0.81,0.946],[-1.24,0.462],[-1.742,-1.303],[-6.895,0.217],[-1.23,-0.426
],[0.121,-1.121],[-0.834,-0.651],[-6.027,0.039],[149.5,-59.43],[-9.033,-1.129],[-1.318,0.758],[0.722,1.563],[-1.636,-0.23],[-0.735,0.462],[-1.938,-0.507
],[-1.703,0.441],[-1.604,-0.744],[-0.965,1.71],[-2.83,-1.951],[0.595,-0.715],[-2.076,-2.082],[-3.72,-0.313],[-0.057,1.393],[-4.183,-0.267],[-0.244,-0.854
],[-4.807,-0.014],[-0.439,0.479],[-0.51,-1.192],[-0.899,0.354],[-2.72,-0.741],[4.484,-2.279],[0.25,-1.09],[-3.059,-1.898],[-2.924,-0.03],[-0.914,0.549
],[-0.269,-1.124],[-2.268,-0.356],[1.36,-0.583],[-1.715,-0.784],[-3.316,1.982],[-0.274,0.977],[-1.836,-0.037],[-2.244,1.161],[-0.815,-0.484],[-2.627,0.2
],[-0.334,0.589],[-2.64,0.28],[-1.945,1.027],[-1.15,0.056],[-1.156,1.309],[0.812,1.002],[-6.311,0.54],[0.988,3.336],[-1.85,-0.965],[-2.074,0.091
],[75.9,-58.876],[0.455,1.188],[-1.07,-0.297],[-0.131,-2.582],[-0.498,0.041],[0.23,1.232],[-1.789,1.125],[1.297,1.312],[-0.557,2.365],[1.094,0.12
],[-0.467,0.947],[0.584,0.793],[-1.133,1.312],[-1.1,0.338],[-0.398,0.472],[-1.143,-0.192],[2.387,-2.834],[-1.102,-0.882],[-0.096,-3.169],[-0.621,-0.519
],[0.738,-2.322],[-2.648,-0.469],[-3.01,5.839],[1.207,0.146],[0.027,0.312],[1.018,0.766],[-0.67,0.74],[-7.961,-2.56],[-0.52,0.497],[1.047,0.854
],[-1.137,0.947],[-1.139,-0.859],[-1.486,0.594],[-1.873,0.039],[54.721,-53.1],[-1.24,-0.146],[0.984,-0.865],[-0.756,-0.069],[-5.576,1.876],[-0.246,0.858
],[-1.545,0.287],[-0.787,-0.454],[-0.006,-0.752],[1.266,-0.17],[-0.57,-0.779],[-2.799,-0.455],[0.736,0.874],[-0.488,0.821],[0.832,0.798],[-0.582,0.898
],[-0.934,-0.454],[-0.924,-0.076],[-2.33,1.258],[0.672,0.909],[-0.842,0.297],[-2.416,-0.764],[-0.637,0.467],[0.602,0.521],[-0.129,0.58],[-2.068,-0.677
],[-0.129,-1.847],[-1.629,-0.951],[0.732,-0.168],[4.465,0.992],[2.742,-1.034],[-0.834,-1.547],[-8.158,-2.866],[-1.031,0.523],[-1.098,-0.952],[1.289,-0.415
],[-3.129,-1.163],[-3.619,0.25],[-1.523,1.304],[-1.645,-0.082],[4.984,-45.486],[0.674,3.566],[1.385,0.506],[1.332,-0.232],[1.975,-1.168],[2.586,3.987
],[1.158,-0.042],[0.566,-0.738],[1.215,0.092],[0.947,-2.536],[1.039,-0.236],[0.92,-1.161],[-1.668,-1.344],[4.25,-3.521],[-0.156,-0.749],[0.971,-0.873
],[1.719,-0.361],[1.391,0.602],[0.105,0.528],[-4.34,2.969],[0.262,2.076],[1.549,0.922],[5.199,-0.69],[1.047,0.5],[-1.135,0.572],[-4.643,0.296
],[0.086,0.58],[0.637,0.354],[0.367,-0.126],[-0.309,1.328],[-0.803,0.018],[-0.793,-0.723],[-0.943,0.332],[-0.312,2.092],[-1.379,0.296],[-0.229,0.396
],[-0.965,-0.012],[-0.076,-0.219],[-0.998,-0.153],[-3.502,0.979],[-1.602,-0.636],[-1.58,0.412],[0.012,-0.316],[-1.01,-0.209],[-0.291,-0.796],[0.721,-0.67
],[0.297,0.102],[0.244,-0.354],[-0.541,-0.143],[0.209,-1.079],[-1.156,0.542],[-0.879,0.06],[-0.455,0.544],[0.711,2.311],[-0.68,0.437],[7.93,-37.371
],[-0.838,0.048],[-0.195,0.188],[-0.83,-0.024],[-1.369,0.365],[-1.391,1.487],[-1.676,0.332],[-0.299,0.674],[-2.33,0.63],[-0.943,-0.346],[0.316,0.904
],[-2.977,-0.031],[0.102,0.572],[3.299,1.485],[-0.707,1.903],[-6.078,-0.233],[-9.4,-28.9],[0.104,3.218],[0.447,0.062],[-0.059,0.921],[0.516,-0.072
],[0.527,0.092],[0.402,-0.17],[0.934,0.103],[0.654,0.593],[0.488,0.054],[1.01,-0.474],[2.225,0.003],[0.707,-0.504],[0.754,-0.131],[0.217,-0.431
],[0.58,-0.299],[-0.391,-0.383],[1.09,-1.165],[1.279,-0.146],[0.947,-0.464],[0.061,-0.839],[3.432,-0.038],[2.359,-0.896],[3.998,2.217],[0.74,0.046
],[0.434,0.277],[0.643,0.125],[0.295,0.297],[0.416,0.084],[0.697,0.733],[-0.428,0.704],[0.418,-0.052],[0.533,-0.571],[0.418,-0.039],[0.119,-0.353
],[-0.723,-0.251],[0.42,-0.441],[0.869,0.112],[0.555,0.318],[0.188,-0.244],[-2.59,-0.947],[0.279,-0.139],[-0.244,-0.155],[-0.783,0.005],[-2.881,-1.898
],[0.066,-0.576],[0.812,-0.264],[0.795,0.106],[-0.258,0.08],[-0.021,0.258],[0.295,0.247],[0.307,-0.317],[0.643,0.115],[0.02,0.25],[0.455,0.308
],[-0.199,0.055],[4.363,1.802],[19.4,-26.957],[0.553,0.229],[0.021,0.149],[0.17,0.047],[1.52,1.848],[0.82,0.283],[0.664,-0.008],[-0.379,-0.575
],[0.635,-0.07],[-0.295,-0.336],[0.924,0.177],[-0.016,-0.375],[-1.053,-0.502],[0.377,-0.146],[-0.723,-0.724],[0.188,-0.15],[0.529,0.354],[24.4,-26.87
],[-0.693,-0.386],[2.342,-0.095],[-0.014,0.142],[0.316,0.319],[1.262,-0.581],[1.188,-0.039],[0.182,-0.17],[-0.873,-0.226],[-0.441,-0.673],[1.162,-1.688
],[0.305,0.068],[0.486,-0.159],[-0.023,-0.189],[1.145,-0.97],[0.928,-0.094],[0.068,0.283],[1.555,0.191],[0.289,0.171],[-0.957,0.249],[-0.176,0.143
],[1.092,0.217],[-0.221,0.347],[0.557,0.147],[2.451,-0.553],[0.195,-0.264],[-1.02,0.044],[-0.492,-0.181],[-0.057,-0.468],[4.158,-0.754],[0.027,0.168
],[-1.475,0.312],[0.559,0.301],[-0.828,0.626],[-0.73,0.118],[4.779,1.885],[0.1,0.782],[-3.205,0.407],[-3.183,-0.76],[-5.926,0.573],[-0.42,0.525
],[-1.539,0.026],[-1.111,0.65],[0.635,0.321],[-0.486,0.521],[1.322,1.021],[1.092,-0.013],[0.969,0.345],[0.689,-0.076],[0.232,-0.27],[1.076,0.021
],[0.809,0.349],[1.52,-0.073],[0.688,-0.374],[1.445,0.095],[-0.377,0.243],[0.367,0.293],[-1.023,1.729],[-0.029,0.008],[-0.609,0.911],[0.068,0.034
],[-0.783,0.354],[-1.582,-0.179],[-0.232,0.199],[-0.271,-0.304],[-1.592,-0.025],[-1.182,0.367],[-3.75,-0.427],[-0.244,-0.203],[-1.684,-0.18
],[-0.342,-0.275],[-2.041,-0.043],[-1.033,0.589],[0.232,0.47],[-0.967,0.437],[-3.373,-0.676],[-0.467,-0.545],[-2.162,-0.381],[-0.42,0.054],[-1.555,-0.312
],[10.85,-22.72],[-0.518,-0.011],[-0.189,-0.344],[0.658,-0.318],[0.133,-0.553],[-0.348,-0.16],[0.006,-0.3],[0.5,-0.318],[-0.07,-0.125],[-0.848,0.239
],[0.029,-0.33],[-0.701,-0.078],[-1.773,0.304],[-0.406,-0.152],[-4.6,-23.707],[-0.604,-0.272],[-0.734,-0.003],[-6.92,-22.93],[-1.746,0.546],[-1.158,1.271
],[0.25,0.755],[-2.123,1.065],[-0.93,0.065],[-3.709,2.905],[0.064,0.192],[-0.711,0.448],[-0.09,0.495],[0.785,0.507],[-0.906,2.834],[-0.439,0.102
],[0.91,0.611],[0.1,0.762],[0.307,0.113],[-0.006,0.082],[1.621,0.611],[0.113,0.234],[1.332,0.694],[0.297,0.582],[5.238,1.804],[12.037,-1],[5.89,-6.198
],[2.602,-0.268],[8.48,-6.32],[0.256,0.076],[8.939,-6.01],[0.457,0.088],[0.391,0.347],[-0.49,0.999],[0.188,0.079],[8.789,-3.39],[3.523,2.608
],[-0.094,0.104],[1.01,1.192],[-0.363,0.319],[0.76,1.525],[-1.9,2.841],[6.516,8.741],[-0.324,0.112],[0.453,0.953],[0.049,-0.088],[0.43,0.282
],[0.338,0.012],[0.424,0.226],[6.162,-0.553],[6.424,-3.176],[0.713,-1.492],[-0.256,-0.04],[-0.086,-0.244],[2.883,-0.923],[0.148,-0.237],[-0.234,-0.099
],[0.191,-0.817],[-0.18,0.027],[-0.598,-1.316],[5.689,-2.399],[-0.16,-2.726],[39.94,1.326],[-0.754,-1.267],[0.275,-0.316],[39.43,-0.393],[-0.641,-0.19
],[12.312,-9.713],[-6.992,0.841],[-1.402,-0.688],[0.57,-0.127],[0.031,-0.223],[-6.348,-4.604],[0.219,-0.103],[-1.662,-1.174],[-0.033,-0.37],[0.199,-0.1
],[32.31,-20.26],[0.104,-0.056],[1.498,1.312],[1.002,-1.103],[-0.291,0.86],[0.498,-0.004],[2.08,1.739],[-0.055,0.13],[5.668,4.99],[-0.121,0.104
],[0.104,0.247],[-0.201,0.026],[0.879,1.386],[1.506,-0.033],[0.154,-0.136],[0.262,-0.039],[0.219,-0.143],[6.543,-1.243],[0.217,-0.427],[1.854,-0.359
],[0.553,0.051],[0.484,-0.151],[-0.006,-0.222],[0.393,-0.138],[0.621,0.005],[0.23,-0.116],[0.096,-0.269],[0.625,-0.205],[0.459,0.002],[0.096,-0.068
],[0.037,-0.652],[0.207,-0.132],[0.453,0.028],[1.318,-1.054],[0.004,-0.126],[-0.359,-0.072],[-0.721,-0.514],[-1.326,-0.179],[-1.006,-0.602],[0.088,-0.802
],[-0.123,-0.051],[-2.355,1.312],[51.783,-16.9],[-0.037,-0.156],[-0.178,0.026],[-0.189,-0.219],[0.199,-0.678],[-0.303,-0.183],[-0.273,0.062
],[-0.203,0.725],[-0.695,-0.688],[0.037,-0.435],[-0.682,-0.247],[-0.172,-0.206],[-0.492,-0.135],[-0.713,-0.96],[0.09,-0.137],[-0.209,-0.266],[0.594,0.029
],[0.373,-0.236],[0.637,0.2],[0.539,-0.099],[1.404,1.363],[3.193,0.812],[1.777,-0.388],[0.479,0.104],[0.426,0.715],[8.977,0.183],[3.271,1.7
],[-0.48,0.203],[1.307,0.68],[0.705,0.066],[72.62,-15.4],[4.91,7.244],[0.738,-0.511],[0.912,-0.149],[78.875,-8.99],[0.455,-0.403],[0.518,-0.026
],[0.467,-2.972],[1.867,-0.357],[0.002,-0.251],[4.838,-2.056],[-0.057,-0.422],[1.912,-0.109],[0.145,-0.205],[0.67,0.111],[0.145,-0.103],[0.426,0.113
],[0.312,-0.313],[-0.09,-0.231],[0.919,0.021],[1.664,1.632],[0.582,0.069],[-0.121,0.2],[0.992,1.149],[-0.344,0.674],[1.18,0.177],[1.797,-0.661
],[1.175,4.887],[0.164,-0.309],[5.019,3.751],[0.709,-0.034],[-0.375,-0.64],[-0.354,-0.144],[-0.123,-1.081],[-1.757,-0.989],[-0.604,-0.062],[-1.146,-1.24
],[-0.648,-0.017],[0.875,-2.218],[0.881,-0.004],[-0.148,0.42],[1.755,0.235],[0.911,0.828],[1.58,0.379],[-0.28,0.357],[0.362,0.34],[4.043,-1.627
],[-0.323,-1.938],[-3.216,-2.065],[2.861,-1.479],[1.342,0.18],[-0.237,0.217],[0.264,0.404],[0.554,-0.032],[0.342,-0.591],[3.021,-0.647],[0.349,0.186
],[6.971,-3.414],[0.561,-0.053],[0.406,-0.959],[-0.588,-0.188],[-0.24,-0.322],[0.629,-0.166],[-1.666,-2.115],[-1.076,-0.35],[1.955,-1.121],[1.414,-0.182
],[122.35,-25.1],[-1.535,-0.274],[-1.121,0.47],[-0.791,-0.19],[-0.032,-0.296],[-0.817,-0.109],[-0.527,-0.449],[0.51,-0.312],[0.98,-0.032],[2.616,-1.156
],[0.529,0.36],[-0.793,0.459],[0.209,0.264],[-0.531,0.312],[3.211,-0.697],[1.058,0.256],[0.063,0.111],[-0.254,0.361],[0.09,0.122],[-0.235,0.078
],[-0.273,0.293],[0.527,0.167],[0.037,0.124],[0.291,-0.055],[0.121,-0.125],[0.485,0.127],[0.687,0.561],[-0.742,0.111],[0.367,1.498],[2.604,-0.438
],[0.371,-1.099],[-2.076,-1.608],[0.117,-0.074],[0.03,-0.293],[2.173,-0.771],[-0.039,-0.498],[0.733,-0.478],[0.379,0.043],[0.156,-0.236],[1.342,-0.521
],[0.629,0.348],[8.438,-8.059],[-1.442,-0.97],[-1.099,-0.057],[-0.642,0.443],[-0.971,-0.197],[-0.494,-0.562],[-1.573,-0.112],[7.069,-4.125],[6.349,-0.126
],[1.237,-0.504],[1.556,0.155],[-0.07,0.735],[3.777,-0.368],[-0.826,-0.631],[2.502,-1.781],[2.582,-0.373],[0.817,1.331],[3.14,-2.104],[1.215,-0.097
],[-6.108,4.746],[-1.553,0.22],[-0.021,6.14],[1.441,-0.781],[0.301,-0.87],[1.49,-0.212],[0.35,-1.01],[1.746,-0.459],[-0.416,-0.393],[0.428,-0.776
],[0.93,-0.034],[0.135,-1.392],[-1.141,-0.22],[1.486,-2.049],[1.336,0.143],[0.965,-0.446],[0.455,0.387],[2.607,-0.823],[1.428,0.728],[7.035,-2.862
],[1.863,0.245],[0.258,-0.298],[-2.074,-2.396],[1.295,0.089],[1.293,-0.543,-5.331],[175.725,-55.694],[175.725,-55.694]];


	// for(var i = 0; i < newForme2.length; i++)
	// {
	// 	var projectPoints = projection([ newForme2[i][0], newForme2[i][1] ], 0);
	// 	centroid.push( [ projectPoints[0], projectPoints[1], 0 ] );
	// }








	// dessin de la carte avec d3
	var svg = d3.select("#conteneur").append("svg")
		.attr("width", width)
	    .attr("height", height)
	    .attr("id","svg");

	    
	var carted3js = svg.attr("id", "carted3js");
	carted3js.selectAll("path").data(results[0].features).enter()
		.append("svg:path")
		.attr("id", function(d){ return d.id; })
		.attr("d", path)
		.style("stroke", "#000")
		.style("fill", "rgba(200,200,200,1)")
		.each(function(d){  

			// verifie si le pays est indexé
			for(var i = 0; i < results[1].length; i++)
			{

				// affecte la hauteur;
				if(results[1][i].iso == d.id)
				{
					// ajout dans les centroids
					var centroidTemporaire = path.centroid(d);
					var hauteur = map(results[1][i].an2013, 0, 180, 0, 20);
					centroid.push( [ centroidTemporaire[0], centroidTemporaire[1], -hauteur ] );
					centroid2d.push({ x: centroidTemporaire[0], y: centroidTemporaire[1], z: -hauteur });

				}
			}

		});


	var svgImg = document.getElementById("carted3js");

    // transforme le svg en image
    var xml = new XMLSerializer().serializeToString(svgImg);
	var data2 = "data:image/svg+xml;base64," + btoa(xml);
	
	imageTexture = new Image(); 
	imageTexture.setAttribute('src', data2);

	// creation du canvas 2d
	var canvas2d = document.createElement( "canvas" );
	canvas2d.width = width;
	canvas2d.height = height;

	var context = canvas2d.getContext( '2d' );

	context.drawImage(imageTexture, 0, 0);
	imageTextureData = context.getImageData( 0, 0, width, height );
	context.putImageData( imageTextureData, 0, 0 );
	//document.body.appendChild(canvas2d);

	// creation de la texture THREE
	var textureCarted3js = new THREE.Texture( canvas2d );
	textureCarted3js.needsUpdate = true;

	callback(null, textureCarted3js);

}



function ready2(error, results)
{  
	// dessin 3d
	canvas = new Canvas();
	canvas.setup(window.innerWidth, window.innerHeight);
	
	dessin = new Dessin();
	dessin.setup(canvas.scene, results[0]);

	dessin.draw(canvas.scene);
	animate();	

}







function animate()
{
	requestAnimationFrame(animate);	
	canvas.draw();
}













/////////////////////////////////////////////
//////////// DESSIN ////////////////////////
////////////////////////////////////////////

var Dessin = function()
{
	this.materialMesh;



	this.setup = function(scene, textureCarted3js)
	{
		
		//MATERIAL
		this.materialMesh = new THREE.MeshLambertMaterial({ 
	    	//map: textureCarted3js,
	    	color:0xffee99,
	    	side: THREE.DoubleSide,
	    	//wireframe: true, 
	    	//wireframeLinewidth: 1
	    });

	    this.materialParticule = new THREE.ParticleBasicMaterial({

      		color: 0xFF0000,
      		size: 1
    	});
		
	}




	this.draw = function(scene)
	{		

		var delaunay = d3.geom.delaunay(centroid);
		var delaunay2 = triangulate(centroid2d);

	    var geometrie = new THREE.Geometry();

	    for (var i=0; i < delaunay2.length; i++ )
	    {

	    	
	    	geometrie.vertices.push(new THREE.Vector3(delaunay2[i].a.x, delaunay2[i].a.y, delaunay2[i].a.z));
	    	geometrie.vertices.push(new THREE.Vector3(delaunay2[i].b.x, delaunay2[i].b.y, delaunay2[i].b.z));
	    	geometrie.vertices.push(new THREE.Vector3(delaunay2[i].c.x, delaunay2[i].c.y, delaunay2[i].c.z));
	    	geometrie.faces.push( new THREE.Face3( 3*i, 1+3*i, 2+3*i ));

	    	geometrie.faceVertexUvs[0].push([
		        new THREE.Vector2( map(delaunay2[i].a.x, 0,width, 0,1), map(delaunay2[i].a.y, 0,height, 1,0) ),
		        new THREE.Vector2( map(delaunay2[i].b.x, 0,width, 0,1), map(delaunay2[i].b.y, 0,height, 1,0) ),
		        new THREE.Vector2( map(delaunay2[i].c.x, 0,width, 0,1), map(delaunay2[i].c.y, 0,height, 1,0) )
	        ]);

	  		// geometrie.vertices.push(new THREE.Vector3(delaunay[i][0][0], delaunay[i][0][1], delaunay[i][0][2]));
			// geometrie.vertices.push(new THREE.Vector3(delaunay[i][1][0], delaunay[i][1][1], delaunay[i][1][2]));
			// geometrie.vertices.push(new THREE.Vector3(delaunay[i][2][0], delaunay[i][2][1], delaunay[i][2][2]));
			// geometrie.faces.push( new THREE.Face3( 3*i, 1+3*i, 2+3*i ));

		    // geometrie.faceVertexUvs[0].push([
		    //     new THREE.Vector2( map(delaunay[i][0][0], 0,width, 0,1), map(delaunay[i][0][1], 0,height, 1,0) ),
		    //     new THREE.Vector2( map(delaunay[i][1][0], 0,width, 0,1), map(delaunay[i][1][1], 0,height, 1,0) ),
		    //     new THREE.Vector2( map(delaunay[i][2][0], 0,width, 0,1), map(delaunay[i][2][1], 0,height, 1,0) )
	     //    ]);

	    }

	    geometrie.computeFaceNormals();

	    var mesh = new THREE.Mesh(geometrie, this.materialMesh);
	    mesh.doubleSided = true;		
	    scene.add(mesh);

		// var particleSystem = new THREE.ParticleSystem( geometrie, this.materialParticule );
		// scene.add(particleSystem);
	    

	}
	
}




















/////////////////////////////////////////////
//////////// CANVAS ////////////////////////
////////////////////////////////////////////

var Canvas = function()
{

	this.camera;
	this.renderer;
	this.scene;
	this.centreCarte;
	this.positionInitCam;
	this.xSouris;
	this.scrollSouris;
	this.spot1;
	this.spot2;
	this.largeurFenetre; this.hauteurFenetre;



	this.setup = function(WIDTH, HEIGHT)
	{

		var VIEW_ANGLE = 45,
		    ASPECT = WIDTH / HEIGHT,
		    NEAR = 0.1,
		    FAR = 10000;


		this.scrollSouris = 100;
		this.centreCarte = projection([0,0]);
		this.positionInitCam = projection([0,-89]);
		this.largeurFenetre = 800;
		this.hauteurFenetre = 600;

		this.scene = new THREE.Scene();

		//this.camera = new THREE.PerspectiveCamera( VIEW_ANGLE, ASPECT, NEAR, FAR );
		this.camera = new THREE.OrthographicCamera( this.largeurFenetre / - 2, this.largeurFenetre / 2, this.hauteurFenetre / 2, this.hauteurFenetre / - 2, 1, 10000 );
		this.camera.position.set(this.positionInitCam[0], this.positionInitCam[1], -200);
		this.camera.lookAt(new THREE.Vector3(this.centreCarte[0], this.centreCarte[1], -100));
		this.camera.up = new THREE.Vector3(0, 0, -1);
		this.scene.add(this.camera);
	
		this.renderer = new THREE.WebGLRenderer();
		this.renderer.setSize(WIDTH, HEIGHT);
		this.renderer.setClearColor("#ffffff", 1);

		// LIGHT
		this.scene.add( new THREE.AmbientLight( 0x888888 ) );

		this.spot1 = new THREE.DirectionalLight( 0x1111cc, 1 );
		this.spot1.position.set( -200, 0, -200 );
		this.scene.add(this.spot1);

		this.spot2 = new THREE.DirectionalLight( 0xcc1111, 0.4 );
		this.spot2.position.set( 200, 0, -200 );
		this.scene.add(this.spot2);


		document.body.appendChild(this.renderer.domElement);
		
		var clone = this;
		document.addEventListener("mousemove", function(event){ clone.onMouseMove(event); }, false);
		document.addEventListener("mousewheel", function(event){ clone.onMouseScroll(event); }, false);
		//document.addEventListener("DOMMouseScroll", function(event){ clone.onMouseScroll(event); }, false);

	}
	
	
	this.draw = function()
	{
		this.renderer.render(this.scene, this.camera);	
	}
	
	
	this.onMouseMove = function(event)
	{
		this.xSouris = event.clientX;

		this.positionCamera();
		//this.camera.position.x = map(this.xSouris, 0, window.innerWidth, -1000, 1000);
		//this.spot2.position.x = map(event.clientY, 0, window.innerHeight, -1000, 1000);
		//this.camera.position.z = map(xSouris, 0, window.innerWidth, -1000, 1000);
		//this.camera.lookAt(new THREE.Vector3(this.centreCarte[0], this.centreCarte[1], -100));
		return false;
	}

	this.onMouseScroll = function(e) {

	    // cross-browser wheel delta
	    var e = window.event || e;
	    var delta = Math.max(-1, Math.min(1, (e.wheelDelta || -e.detail)));
	    this.scrollSouris += delta;
	    this.scrollSouris = Math.min(this.scrollSouris, 70);
	    this.scrollSouris = Math.max(this.scrollSouris, 40);
		
		this.positionCamera();
	    return false;
	
	}

	this.positionCamera = function()
	{

		var coordonneesCamera = []
		var angleMax = 180;
		var angleOrbiteCamera, rayonOrbiteCamera;
		var rayonMin = 100;
		var rayonMax = projection([180,0]);
			rayonMax = rayonMax[1];

		angleOrbiteCamera =  angleMax * this.xSouris / largeurFenetre;

		// calcul du rayon de l'orbite de la caméra
		rayonOrbiteCamera = this.positionInitCam[1]*this.scrollSouris/100
		coordonneesCamera = [Math.cos(angleOrbiteCamera*(Math.PI/180))*rayonOrbiteCamera, Math.sin(angleOrbiteCamera*(Math.PI/180))*rayonOrbiteCamera] ;
		
		this.camera.position.x = coordonneesCamera[0]+this.positionInitCam[0];
		this.camera.position.y = coordonneesCamera[1];
		this.camera.lookAt( new THREE.Vector3(this.centreCarte[0], this.centreCarte[1], -100) );

	}


	

	
}














